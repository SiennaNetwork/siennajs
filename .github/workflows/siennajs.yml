name: SiennaJS
on: [push, pull_request]

jobs:
  js:
    name: check, build, fix, and release
    runs-on: ubuntu-latest
    steps:

      # Get source:
      - uses: actions/checkout@v2
        with: { submodules: recursive }

      # Get Node:
      - uses: actions/setup-node@v3
        with: { node-version: 18 }

      # Get PNPM:
      - run: npm i -g pnpm@^7.5.2

      # Don't compile native modules:
      - run: pnpm config set node-gyp /bin/true

      # Install deps:
      - run: pnpm i

      # Check types:
      - run: npm run check

      # Build for packaging
      - run: npm run release:ci

      # Fix TypeScript insanity
      - run: npx -y tsc-esm-fix

      # Package
      # See: https://docs.github.com/en/actions/using-workflows/workflow-commands-for-github-actions
      - id:  pack
        run: echo "::set-output name=file::$(npm pack | tail -n1)" # lol

      # Make sure release can be installed
      - run: |
          pwd
          mkdir /tmp/downstream
          cd /tmp/downstream
          echo "{}" > package.json
          npm i --save /src/${{ steps.pack.outputs.file }}
          cat package.json

      # Upload release
      - uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ steps.pack.outputs.file }}
          body:  Automated release by https://github.com/softprops/action-gh-release
